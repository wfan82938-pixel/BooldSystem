<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½é…å‹ä¸­å¿ƒ</title>
    <!-- CSRF Token -->
    <meta th:if="${_csrf}" name="_csrf" th:content="${_csrf.token}"/>
    <meta th:if="${_csrf}" name="_csrf_header" th:content="${_csrf.headerName}"/>

    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        body { background-color: #f5f7fa; font-family: system-ui, -apple-system, sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        body::after {
            content: "ç§‘ç ”è¾…åŠ© Â· ä»…ä¾›å‚è€ƒ";
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 6rem; color: rgba(0,0,0,0.04); pointer-events: none; z-index: 9999; white-space: nowrap; font-weight: 800;
        }

        .main-container { flex: 1; display: flex; overflow: hidden; position: relative; z-index: 10; }
        .sidebar { width: 360px; background: #fff; border-right: 1px solid #eef1f6; display: flex; flex-direction: column; z-index: 90; box-shadow: 4px 0 10px rgba(0,0,0,0.02); }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #f0f2f5; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; }
        .content-area { flex: 1; padding: 30px; overflow-y: auto; background: #f5f7fa; position: relative; display: flex; flex-direction: column; }

        .form-section-title { font-size: 0.85rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin: 20px 0 10px; }
        .gene-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #f1f5f9; }
        .gene-name { font-weight: 600; font-size: 0.9rem; color: #334155; width: 60px; }

        .result-card {
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            padding: 16px 20px;
            margin-bottom: 12px;
            transition: all 0.2s;
            position: relative;
        }
        .result-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.04); border-color: #cbd5e1; }
        .result-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background: #cbd5e1; border-top-left-radius: 12px; border-bottom-left-radius: 12px; }

        .result-card.score-high::before { background: #10b981; }
        .result-card.score-mid::before { background: #0ea5e9; }
        .result-card.score-low::before { background: #f59e0b; }
        .result-card.score-excluded { border: 1px solid #fca5a5; background: #fff5f5; opacity: 0.9; }
        .result-card.score-excluded::before { background: #ef4444; }

        .score-box { position: absolute; right: 20px; top: 16px; text-align: right; }
        .score-num { font-size: 1.8rem; font-weight: 800; line-height: 1; letter-spacing: -1px; }
        .score-label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 600; margin-top: 2px; }

        .grade-circle { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; color: #fff; position: absolute; right: 80px; top: 18px; }
        .grade-A { background: #10b981; }
        .grade-B { background: #0ea5e9; }
        .grade-C { background: #f59e0b; }
        .grade-D { background: #94a3b8; }
        .grade-Ex { background: #ef4444; }

        .hla-row { display: flex; align-items: center; gap: 30px; padding-top: 12px; border-top: 1px dashed #f1f5f9; margin-top: 10px; }
        .hla-group { display: flex; align-items: center; gap: 8px; }
        .hla-label { font-weight: 700; color: #1e293b; font-size: 0.9rem; }
        .hla-val-box { background: #f1f5f9; padding: 2px 8px; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 0.85rem; color: #475569; border: 1px solid #e2e8f0; }
        .hla-val-box.matched { background: #dcfce7; color: #15803d; border-color: #86efac; }
        .divider { color: #cbd5e1; font-size: 0.8rem; }

        .hpa-tags-row { margin-top: 8px; min-height: 24px; display: flex; flex-wrap: wrap; gap: 6px; }

        .btn-confirm { position: absolute; right: 20px; bottom: 16px; font-size: 0.85rem; font-weight: 600; padding: 4px 12px; }

        .antibody-container { min-height: 80px; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px; cursor: text; display: flex; flex-wrap: wrap; gap: 6px; }
        .antibody-container:focus-within { border-color: #ef4444; box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1); }
        .antibody-tag { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; border-radius: 100px; padding: 2px 10px; font-size: 0.85rem; font-family: 'Consolas', monospace; display: flex; align-items: center; gap: 6px; }
        .antibody-input-field { border: none; outline: none; font-size: 0.9rem; flex: 1; min-width: 60px; background: transparent; }

        #loadingOverlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(245,247,250,0.8); backdrop-filter: blur(2px); z-index: 50; display: none; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div th:replace="~{fragments :: navbar('match')}"></div>

<div class="main-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="btn btn-success w-100 py-2 fw-bold shadow-sm" id="btnMatch" onclick="doMatch()">
                <i class="bi bi-search me-1"></i> ç«‹å³é…å‹
            </button>
            <button class="btn btn-light w-100 mt-2 text-muted btn-sm" onclick="resetForm()">
                <i class="bi bi-arrow-counterclockwise me-1"></i> é‡ç½®æ¡ä»¶
            </button>
        </div>

        <div class="sidebar-content">
            <div class="mb-4 p-3 bg-light rounded border">
                <label class="small fw-bold text-dark mb-1">æ‚£è€…å§“å <span class="text-danger">*</span></label>
                <input type="text" id="patientName" class="form-control form-control-sm" placeholder="è¯·è¾“å…¥æˆ–æœç´¢æ‚£è€…..." required>
                <input type="hidden" id="currentPatientId">
                <div class="form-text text-xs" style="font-size:0.75rem">åŒ¹é…æˆåŠŸåå°†è‡ªåŠ¨ä¸ºè¯¥æ‚£è€…å»ºç«‹æ¡£æ¡ˆ</div>
            </div>

            <div class="form-section-title">åŸºç¡€ä¿¡æ¯</div>
            <div class="mb-3">
                <label class="small text-muted mb-1">æ‚£è€…è¡€å‹</label>
                <select class="form-select" id="bloodType">
                    <option value="">ä¸é™</option>
                    <option value="A">A å‹</option>
                    <option value="B">B å‹</option>
                    <option value="O">O å‹</option>
                    <option value="AB">AB å‹</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="small text-muted mb-1 fw-bold text-danger d-flex justify-content-between">
                    <span>æ’é™¤æŠ—ä½“ (DSA)</span> <i class="bi bi-shield-x"></i>
                </label>
                <div class="antibody-container" id="antibodyWrapper" onclick="document.getElementById('antibodyInput').focus()">
                    <input type="text" class="antibody-input-field" id="antibodyInput" placeholder="è¾“å…¥åå›è½¦..." autocomplete="off">
                </div>
                <input type="hidden" id="antibodiesHidden">
            </div>

            <div class="form-section-title">HLA é«˜åˆ†è¾¨åˆ†å‹</div>
            <div class="mb-3">
                <label class="small text-muted mb-1">HLA-A ä½ç‚¹</label>
                <div class="input-group input-group-sm mb-1">
                    <span class="input-group-text bg-light text-secondary" style="width:35px">1</span>
                    <input type="text" class="form-control font-monospace" id="hlaA1" placeholder="ä¾‹ 30:01" oninput="this.value = this.value.toUpperCase()">
                </div>
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-light text-secondary" style="width:35px">2</span>
                    <input type="text" class="form-control font-monospace" id="hlaA2" placeholder="ä¾‹ 02:01" oninput="this.value = this.value.toUpperCase()">
                </div>
            </div>
            <div class="mb-3">
                <label class="small text-muted mb-1">HLA-B ä½ç‚¹</label>
                <div class="input-group input-group-sm mb-1">
                    <span class="input-group-text bg-light text-secondary" style="width:35px">1</span>
                    <input type="text" class="form-control font-monospace" id="hlaB1" placeholder="ä¾‹ 13:02" oninput="this.value = this.value.toUpperCase()">
                </div>
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-light text-secondary" style="width:35px">2</span>
                    <input type="text" class="form-control font-monospace" id="hlaB2" placeholder="ä¾‹ 15:18" oninput="this.value = this.value.toUpperCase()">
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="form-section-title mb-0">HPA åŸºå› å‹</div>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-xs btn-link text-decoration-none text-muted p-0 me-2" onclick="setAllHpa('aa')">å…¨aa</button>
                    <button class="btn btn-xs btn-link text-decoration-none text-muted p-0" onclick="setAllHpa('bb')">å…¨bb</button>
                </div>
            </div>
            <div id="hpaListContainer"></div>
        </div>

        <div class="p-3 border-top bg-light">
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="limitResult">
                <label class="form-check-label small text-muted" for="limitResult">ä»…æ˜¾ç¤ºå‰ 50 æ¡</label>
            </div>
        </div>
    </div>

    <div class="content-area">
        <div id="loadingOverlay">
            <div class="spinner-border text-success mb-2" role="status"></div>
            <div class="text-muted small fw-bold">æ­£åœ¨å…¨åº“æ£€ç´¢...</div>
        </div>

        <div class="d-flex justify-content-between align-items-end mb-4">
            <div>
                <h4 class="fw-bold text-dark mb-1">é…å‹ç»“æœ</h4>
                <div class="text-muted small" id="resultStatus">è¾“å…¥å·¦ä¾§æ¡ä»¶è¿›è¡Œæ£€ç´¢</div>
            </div>
        </div>

        <div id="resultList">
            <div class="text-center py-5 mt-5">
                <i class="bi bi-clipboard-data display-1 text-light"></i>
                <p class="text-muted mt-3">ç­‰å¾…è¾“å…¥é…å‹æ¡ä»¶...</p>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/js/jquery.min.js}"></script>
<script th:src="@{/js/bootstrap.bundle.min.js}"></script>

<script>
    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");
    if (token && header) {
        $(document).ajaxSend(function(e, xhr, options) { xhr.setRequestHeader(header, token); });
    }

    const hpas = ['HPA-1', 'HPA-2', 'HPA-3', 'HPA-4', 'HPA-5', 'HPA-6', 'HPA-10', 'HPA-15', 'HPA-21'];
    hpas.forEach(h => {
        $('#hpaListContainer').append(`
            <div class="gene-row">
                <div class="gene-name">${h}</div>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="${h}" id="${h}_aa" value="aa"><label class="btn btn-outline-secondary py-0" for="${h}_aa">aa</label>
                    <input type="radio" class="btn-check" name="${h}" id="${h}_ab" value="ab"><label class="btn btn-outline-secondary py-0" for="${h}_ab">ab</label>
                    <input type="radio" class="btn-check" name="${h}" id="${h}_bb" value="bb"><label class="btn btn-outline-secondary py-0" for="${h}_bb">bb</label>
                </div>
            </div>
        `);
    });

    const antibodyInput = document.getElementById('antibodyInput');
    let tags = [];
    function updateTags() {
        document.querySelectorAll('.antibody-tag').forEach(t => t.remove());
        tags.forEach((tag, index) => {
            const el = document.createElement('div');
            el.className = 'antibody-tag';
            el.innerHTML = `${tag} <i class="bi bi-x" onclick="removeTag(${index})"></i>`;
            document.getElementById('antibodyWrapper').insertBefore(el, antibodyInput);
        });
        document.getElementById('antibodiesHidden').value = tags.join(',');
    }
    function addTag(text) {
        const clean = text.trim().toUpperCase().replace(/[^A-Z0-9:*]/g, '');
        if (clean && !tags.includes(clean)) { tags.push(clean); updateTags(); }
        antibodyInput.value = '';
    }
    window.removeTag = (idx) => { tags.splice(idx, 1); updateTags(); };
    antibodyInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ',') { e.preventDefault(); addTag(this.value); }
        else if (e.key === 'Backspace' && !this.value) { removeTag(tags.length - 1); }
    });
    antibodyInput.addEventListener('blur', function() { if(this.value) addTag(this.value); });

    function setAllHpa(val) { hpas.forEach(h => $(`input[name="${h}"][value="${val}"]`).prop('checked', true)); }

    function resetForm() {
        $('input[type="radio"]').prop('checked', false);
        $('#bloodType,#patientName,#hlaA1,#hlaA2,#hlaB1,#hlaB2').val('');
        $('#currentPatientId').val('');
        tags=[]; updateTags();
        $('#resultList').html('<div class="text-center py-5 mt-5"><i class="bi bi-arrow-counterclockwise display-1 text-light"></i><p class="text-muted mt-3">æ¡ä»¶å·²é‡ç½®</p></div>');
    }

    function gatherParams() {
        const cleanHla = (val) => val ? val.trim().replace(/ï¼š/g, ':').replace(/\s+/g, '') : '';
        if(antibodyInput.value.trim()) addTag(antibodyInput.value);

        let params = {
            patientName: $('#patientName').val(),
            bloodType: $('#bloodType').val(),
            limitResult: $('#limitResult').is(':checked'),
            antibodies: $('#antibodiesHidden').val(),
            hlaA1: cleanHla($('#hlaA1').val()),
            hlaA2: cleanHla($('#hlaA2').val()),
            hlaB1: cleanHla($('#hlaB1').val()),
            hlaB2: cleanHla($('#hlaB2').val())
        };
        hpas.forEach(h => {
            let val = $(`input[name="${h}"]:checked`).val();
            if (val) params['hpa' + h.split('-')[1]] = val;
        });
        return params;
    }

    function doMatch() {
        let params = gatherParams();
        if (!params.patientName) {
            alert("è¯·å…ˆè¾“å…¥æ‚£è€…å§“åï¼(ç”¨äºè®°å½•å½’æ¡£)");
            $('#patientName').focus();
            return;
        }

        $('#loadingOverlay').css('display', 'flex');
        $('#btnMatch').prop('disabled', true);

        $.post('/api/match', params, function(data) {
            renderResults(data);
        }).always(function() {
            $('#loadingOverlay').hide();
            $('#btnMatch').prop('disabled', false);
        });
    }

    window.selectMatch = function(donorId, score, grade) {
        if(!confirm("ç¡®å®šè¦é€‰ä¸­è¯¥ä¾›è€…å—ï¼Ÿ\nç³»ç»Ÿå°†è‡ªåŠ¨ä¿å­˜æ‚£è€…ä¿¡æ¯å¹¶ç”Ÿæˆé…å‹è®°å½•ã€‚")) return;

        let params = gatherParams();
        params.donorId = donorId;
        params.score = score;
        params.grade = grade;
        params.currentPatientId = $('#currentPatientId').val();

        $.post('/api/confirmMatch', params, function(returnedId) {
            if(returnedId) {
                alert("åŒ¹é…æˆåŠŸï¼å·²å½’æ¡£ã€‚");
                $('#currentPatientId').val(returnedId);
            }
        }).fail(function() {
            alert("æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•");
        });
    };

    function renderResults(data) {
        const container = $('#resultList');
        container.empty();

        if (data.length === 0) {
            container.html('<div class="alert alert-warning text-center">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä¾›è€…</div>');
            return;
        }

        $('#resultStatus').html(`æ‰¾åˆ° <strong>${data.length}</strong> æ¡è®°å½•`);

        data.forEach(item => {
            const d = item.donor;
            const isExcluded = item.score < 0;
            let cardClass = isExcluded ? 'score-excluded' : 'score-mid';
            let scoreColor = '#0ea5e9';
            let gradeClass = 'grade-D';

            if (!isExcluded) {
                if (item.score >= 300) { cardClass = 'score-high'; scoreColor = '#10b981'; }
                else if (item.score < 100) { cardClass = 'score-low'; scoreColor = '#f59e0b'; }
                if (item.grade === 'A') gradeClass = 'grade-A';
                else if (item.grade === 'B') gradeClass = 'grade-B';
                else if (item.grade === 'C') gradeClass = 'grade-C';
            } else {
                scoreColor = '#ef4444'; gradeClass = 'grade-Ex';
            }

            let actionBtn = '';
            if(!isExcluded) {
                actionBtn = `
                    <button class="btn btn-outline-primary btn-confirm"
                            onclick="selectMatch('${d.donorId}', ${item.score}, '${item.grade}')">
                        <i class="bi bi-check2-circle me-1"></i>ç¡®è®¤é€‰ä¸­
                    </button>
                `;
            }

            // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šåŸºäºé…å‹çŠ¶æ€åˆ†ç±»å¤„ç†é¢œè‰²
            // ç»“æ„åŒ– HPA æ•°æ®ï¼Œæ–¹ä¾¿ç»Ÿä¸€å¤„ç†
            let hpaDisplayList = [];

            // 1. é€‚é… (Matched) -> ç»¿è‰²
            if (item.matchedLoci) {
                item.matchedLoci.forEach(l => {
                    if (!l.startsWith('HLA')) hpaDisplayList.push({ name: l, type: 'matched' });
                });
            }
            // 2. å…¼å®¹ (Compatible) -> è“è‰²
            if (item.compatibleLoci) {
                item.compatibleLoci.forEach(l => {
                    if (!l.startsWith('HLA')) hpaDisplayList.push({ name: l, type: 'compatible' });
                });
            }
            // 3. ä¸é€‚é… (Mismatched) -> ç°è‰²
            if (item.mismatchedLoci) {
                item.mismatchedLoci.forEach(l => {
                    if (!l.startsWith('HLA')) hpaDisplayList.push({ name: l, type: 'mismatched' });
                });
            }

            // æ’åº (HPA-1, HPA-2...)
            hpaDisplayList.sort((a,b) => {
                let n1 = parseInt(a.name.replace('HPA-',''));
                let n2 = parseInt(b.name.replace('HPA-',''));
                return n1 - n2;
            });

            // ç”Ÿæˆ HPA æ ‡ç­¾ HTML
            let tagsHtml = '';
            hpaDisplayList.forEach(obj => {
                let propName = obj.name.toLowerCase().replace('-', '');
                let val = d[propName] || '?';

                let cssClass = '';
                // ğŸ”¥ æŒ‰åŒ¹é…çŠ¶æ€å®šè‰² (é€‚é…=ç»¿, å…¼å®¹=è“, å¦åˆ™=ç°)
                if (obj.type === 'matched') {
                    cssClass = 'bg-success bg-opacity-10 text-success border-success';
                } else if (obj.type === 'compatible') {
                    cssClass = 'bg-primary bg-opacity-10 text-primary border-primary';
                } else {
                    cssClass = 'bg-secondary bg-opacity-10 text-secondary border-secondary';
                }

                tagsHtml += `<span class="badge border bg-opacity-10 ${cssClass}">${obj.name}:${val}</span>`;
            });

            const hA1 = item.highlightedAlleles.includes("HLA-A1");
            const hA2 = item.highlightedAlleles.includes("HLA-A2");
            const hB1 = item.highlightedAlleles.includes("HLA-B1");
            const hB2 = item.highlightedAlleles.includes("HLA-B2");

            let hlaHtml = '';
            if(d.hlaA1 || d.hlaB1) {
                hlaHtml = `
                    <div class="hla-row">
                        <div class="hla-group">
                            <span class="hla-label">HLA-A:</span>
                            <span class="hla-val-box ${hA1?'matched':''}">${d.hlaA1||'-'}</span>
                            <span class="divider">|</span>
                            <span class="hla-val-box ${hA2?'matched':''}">${d.hlaA2||'-'}</span>
                        </div>
                        <div class="hla-group">
                            <span class="hla-label">HLA-B:</span>
                            <span class="hla-val-box ${hB1?'matched':''}">${d.hlaB1||'-'}</span>
                            <span class="divider">|</span>
                            <span class="hla-val-box ${hB2?'matched':''}">${d.hlaB2||'-'}</span>
                        </div>
                    </div>`;
            }

            let conflictHtml = isExcluded ? `<div class="mt-2 text-danger small fw-bold">æ’é™¤åŸå› ï¼š${item.conflictReasons.join(', ')}</div>` : '';

            let displayGrade = isExcluded ? 'X' : item.grade;
            let scoreDisplay = isExcluded ? `<div class="text-danger fw-bold fs-3">ç¦å¿Œ</div>` : `<div class="score-num" style="color:${scoreColor}">${item.score.toFixed(0)}</div><div class="score-label">æ€»åˆ†</div>`;

            const html = `
                <div class="result-card ${cardClass}">
                    <div class="grade-circle ${gradeClass}">${displayGrade}</div>
                    <div class="score-box">${scoreDisplay}</div>

                    <div style="margin-right: 140px;">
                        <div class="d-flex align-items-center gap-2">
                            <h6 class="fw-bold text-dark mb-0">${d.name}</h6>
                            <span class="badge bg-light text-dark border">${d.bloodType}å‹</span>
                            <span class="small text-muted font-monospace">ID: ${d.donorId}</span>
                        </div>
                        <div class="hpa-tags-row">${tagsHtml}</div>
                        ${conflictHtml}
                        ${hlaHtml}
                    </div>
                    ${actionBtn}
                </div>
            `;
            container.append(html);
        });
    }
</script>
</body>
</html>